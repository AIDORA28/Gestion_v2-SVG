<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Debug Console - Ingresos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto p-8">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="bg-gray-800 rounded-lg p-6 mb-6">
                <h1 class="text-3xl font-bold text-green-400 mb-4">üß™ DEBUG CONSOLE - M√≥dulo Ingresos</h1>
                <p class="text-gray-300">Herramientas de diagn√≥stico y prueba para el sistema de ingresos</p>
            </div>

            <!-- Panel de Control Debug -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Comandos de Diagn√≥stico -->
                <div class="bg-gray-800 rounded-lg p-6">
                    <h2 class="text-xl font-bold text-blue-400 mb-4">üîç Diagn√≥stico</h2>
                    <div class="space-y-3">
                        <button onclick="runDiagnostic()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                            üîç Ejecutar Diagn√≥stico Completo
                        </button>
                        <button onclick="checkAuth()" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">
                            üîê Verificar Autenticaci√≥n
                        </button>
                        <button onclick="testSupabaseConnection()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                            üåê Test Conexi√≥n Supabase
                        </button>
                        <button onclick="checkTemplate()" class="w-full bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg">
                            üìÑ Verificar Template
                        </button>
                    </div>
                </div>

                <!-- Comandos de Prueba -->
                <div class="bg-gray-800 rounded-lg p-6">
                    <h2 class="text-xl font-bold text-red-400 mb-4">üß™ Pruebas</h2>
                    <div class="space-y-3">
                        <button onclick="runDebugTest()" class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">
                            üöÄ Prueba Completa por Consola
                        </button>
                        <button onclick="initializeSystem()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg">
                            ‚ö° Inicializar Sistema
                        </button>
                        <button onclick="testFormSubmit()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">
                            üìù Test Env√≠o Manual
                        </button>
                        <button onclick="ejecutarPruebaAutomatica()" class="w-full bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg">
                            ü§ñ Prueba Autom√°tica
                        </button>
                        <button onclick="clearConsole()" class="w-full bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
                            üßπ Limpiar Console
                        </button>
                    </div>
                </div>
            </div>

            <!-- Estados del Sistema -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-gray-800 p-4 rounded-lg">
                    <h3 class="font-bold text-green-400 mb-2">üîê Auth</h3>
                    <div id="status-auth" class="text-sm text-gray-300">No verificado</div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg">
                    <h3 class="font-bold text-blue-400 mb-2">üåê Supabase</h3>
                    <div id="status-supabase" class="text-sm text-gray-300">No verificado</div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg">
                    <h3 class="font-bold text-yellow-400 mb-2">üìÑ Template</h3>
                    <div id="status-template" class="text-sm text-gray-300">No verificado</div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg">
                    <h3 class="font-bold text-purple-400 mb-2">üß† Handler</h3>
                    <div id="status-handler" class="text-sm text-gray-300">No verificado</div>
                </div>
            </div>

            <!-- √Årea del M√≥dulo (para pruebas visuales) -->
            <div class="bg-gray-800 rounded-lg p-6 mb-6">
                <h2 class="text-xl font-bold text-green-400 mb-4">üéÆ √Årea de Pruebas Visuales</h2>
                <button onclick="loadModuleForTesting()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg mb-4">
                    üì¶ Cargar M√≥dulo de Ingresos
                </button>
                <div id="module-area" class="bg-gray-700 rounded-lg p-4 min-h-48">
                    <p class="text-gray-400 text-center">√Årea de pruebas - Carga el m√≥dulo para probar visualmente</p>
                </div>
            </div>

            <!-- Console Output -->
            <div class="bg-black rounded-lg p-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-green-400">üíª Console Output</h2>
                    <button onclick="clearConsole()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                        Clear
                    </button>
                </div>
                <div id="debug-output" class="font-mono text-sm text-green-400 max-h-96 overflow-y-auto">
                    <div class="text-yellow-400">[SISTEMA] Debug Console inicializado</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../public/js/supabase-config.js"></script>
    <script src="../public/js/config.js"></script>
    <script src="../public/js/supabase-auth.js"></script>
    <script src="../public/js/module-loader.js"></script>
    <script src="../public/js/ingresos-module-handler.js"></script>

    <script>
        // Funci√≥n para logging personalizado
        function debugLog(message, type = 'info') {
            const output = document.getElementById('debug-output');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-green-400',
                error: 'text-red-400',
                warning: 'text-yellow-400',
                success: 'text-blue-400',
                system: 'text-purple-400'
            };
            
            const div = document.createElement('div');
            div.className = colors[type];
            div.innerHTML = `[${timestamp}] ${message}`;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
            
            // Tambi√©n al console del navegador
            console.log(`[DEBUG] ${message}`);
        }

        function updateStatus(component, status, message = '') {
            const element = document.getElementById(`status-${component}`);
            if (element) {
                const colors = {
                    ok: 'text-green-400',
                    error: 'text-red-400',
                    warning: 'text-yellow-400',
                    loading: 'text-blue-400'
                };
                
                element.className = `text-sm ${colors[status] || 'text-gray-300'}`;
                element.textContent = message || status.toUpperCase();
            }
        }

        async function runDiagnostic() {
            debugLog('üîç === EJECUTANDO DIAGN√ìSTICO COMPLETO ===', 'system');
            
            try {
                if (window.diagnosticIngresos) {
                    const result = await window.diagnosticIngresos();
                    debugLog('‚úÖ Diagn√≥stico completado', 'success');
                    
                    // Actualizar estados visuales
                    updateStatus('auth', result.auth ? 'ok' : 'error');
                    updateStatus('supabase', result.supabase ? 'ok' : 'error');
                    updateStatus('template', result.template ? 'ok' : 'error');
                    updateStatus('handler', window.ingresosModuleHandler ? 'ok' : 'error');
                    
                } else if (window.ingresosModuleHandler && window.ingresosModuleHandler.diagnosticCheck) {
                    const result = await window.ingresosModuleHandler.diagnosticCheck();
                    debugLog('‚úÖ Diagn√≥stico completado', 'success');
                    
                    // Actualizar estados visuales
                    updateStatus('auth', result.auth ? 'ok' : 'error');
                    updateStatus('supabase', result.supabase ? 'ok' : 'error');
                    updateStatus('template', result.template ? 'ok' : 'error');
                    updateStatus('handler', window.ingresosModuleHandler ? 'ok' : 'error');
                    
                } else {
                    debugLog('‚ùå Funci√≥n diagnosticIngresos no disponible', 'error');
                }
            } catch (error) {
                debugLog(`‚ùå Error en diagn√≥stico: ${error.message}`, 'error');
            }
        }

        async function runDebugTest() {
            debugLog('üß™ === EJECUTANDO PRUEBA COMPLETA ===', 'system');
            
            try {
                if (window.debugIngresos) {
                    const result = await window.debugIngresos();
                    debugLog('üéâ Prueba completada exitosamente', 'success');
                    debugLog(`üìä Resultado: ${JSON.stringify(result, null, 2)}`, 'info');
                } else if (window.ingresosModuleHandler && window.ingresosModuleHandler.debugTest) {
                    const result = await window.ingresosModuleHandler.debugTest();
                    debugLog('üéâ Prueba completada exitosamente', 'success');
                    debugLog(`üìä Resultado: ${JSON.stringify(result, null, 2)}`, 'info');
                } else {
                    debugLog('‚ùå Funci√≥n debugIngresos no disponible', 'error');
                    debugLog('üí° Inicializa el sistema primero', 'warning');
                }
            } catch (error) {
                debugLog(`‚ùå Error en prueba: ${error.message}`, 'error');
                debugLog(`üìã Stack trace: ${error.stack}`, 'error');
            }
        }

        async function initializeSystem() {
            debugLog('‚ö° Inicializando sistema...', 'system');
            updateStatus('handler', 'loading', 'Inicializando...');
            
            try {
                // Cargar template si no existe
                if (!document.getElementById('ingreso-modal')) {
                    debugLog('üìÑ Cargando template...', 'info');
                    const html = await window.moduleLoader.loadTemplate('ingresos');
                    
                    // Crear contenedor temporal
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    document.body.appendChild(tempDiv);
                }
                
                // Inicializar handler
                if (!window.ingresosModuleHandler) {
                    debugLog('üß† Creando handler...', 'info');
                    window.ingresosModuleHandler = new IngresosModuleHandler();
                    await window.ingresosModuleHandler.init();
                }
                
                updateStatus('handler', 'ok', 'Activo');
                debugLog('‚úÖ Sistema inicializado correctamente', 'success');
                
            } catch (error) {
                updateStatus('handler', 'error', 'Error');
                debugLog(`‚ùå Error inicializando: ${error.message}`, 'error');
            }
        }

        async function checkAuth() {
            debugLog('üîê Verificando autenticaci√≥n...', 'info');
            updateStatus('auth', 'loading', 'Verificando...');
            
            const token = localStorage.getItem('supabase_access_token');
            const user = localStorage.getItem('currentUser');
            
            if (token && user) {
                const userData = JSON.parse(user);
                updateStatus('auth', 'ok', userData.email);
                debugLog(`‚úÖ Autenticado como: ${userData.email}`, 'success');
                debugLog(`üîë Token: ${token.substring(0, 50)}...`, 'info');
            } else {
                updateStatus('auth', 'error', 'Sin autenticar');
                debugLog('‚ùå No hay autenticaci√≥n v√°lida', 'error');
                debugLog('üí° Usa: joegarcia.1395@gmail.com / 123456', 'warning');
            }
        }

        async function testSupabaseConnection() {
            debugLog('üåê Probando conexi√≥n con Supabase...', 'info');
            updateStatus('supabase', 'loading', 'Probando...');
            
            try {
                const response = await fetch('https://lobyofpwqwqsszugdwnw.supabase.co/rest/v1/', {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxvYnlvZnB3cXdxc3N6dWdkd253Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczMTU4NDIsImV4cCI6MjA3Mjg5MTg0Mn0.QsZ2dIU1iPffRGtHUREQIhQ5--7_w4ANowG0rJ0AtcI'
                    }
                });
                
                updateStatus('supabase', 'ok', 'Conectado');
                debugLog(`‚úÖ Supabase conectado - Status: ${response.status}`, 'success');
            } catch (error) {
                updateStatus('supabase', 'error', 'Error');
                debugLog(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        function checkTemplate() {
            debugLog('üìÑ Verificando template...', 'info');
            
            const modal = document.getElementById('ingreso-modal');
            const form = document.getElementById('ingreso-form');
            
            if (modal && form) {
                updateStatus('template', 'ok', 'Cargado');
                debugLog('‚úÖ Template cargado correctamente', 'success');
                
                // Verificar campos
                const fields = ['descripcion', 'monto', 'categoria', 'fecha'];
                const missing = fields.filter(f => !document.getElementById(f));
                
                if (missing.length === 0) {
                    debugLog('‚úÖ Todos los campos del formulario presentes', 'success');
                } else {
                    debugLog(`‚ö†Ô∏è Campos faltantes: ${missing.join(', ')}`, 'warning');
                }
            } else {
                updateStatus('template', 'error', 'No cargado');
                debugLog('‚ùå Template no cargado', 'error');
            }
        }

        async function loadModuleForTesting() {
            debugLog('üì¶ Cargando m√≥dulo para pruebas visuales...', 'info');
            
            try {
                // Cargar moduleLoader si no existe
                if (!window.moduleLoader) {
                    debugLog('‚ö†Ô∏è ModuleLoader no disponible, creando instancia...', 'warning');
                    // Implementaci√≥n simple para cargar template
                    const response = await fetch('../public/modules/ingresos-template.html');
                    const html = await response.text();
                    
                    const moduleArea = document.getElementById('module-area');
                    moduleArea.innerHTML = html;
                } else {
                    const moduleArea = document.getElementById('module-area');
                    const html = await window.moduleLoader.loadTemplate('ingresos');
                    moduleArea.innerHTML = html;
                }
                
                // Inicializar sistema
                await initializeSystem();
                
                // Inicializar iconos
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
                
                debugLog('‚úÖ M√≥dulo cargado en √°rea de pruebas', 'success');
                
            } catch (error) {
                debugLog(`‚ùå Error cargando m√≥dulo: ${error.message}`, 'error');
            }
        }

        async function testFormSubmit() {
            debugLog('üìù Probando env√≠o manual de formulario...', 'info');
            
            if (!window.ingresosModuleHandler) {
                debugLog('‚ö†Ô∏è Sistema no inicializado, inicializando...', 'warning');
                await initializeSystem();
            }
            
            // Simular datos de formulario
            const mockData = {
                descripcion: 'Test Manual Console',
                monto: '777.77',
                categoria: 'Salario',
                fecha: new Date().toISOString().split('T')[0],
                notas: 'Prueba manual desde debug console'
            };
            
            debugLog(`üìä Datos de prueba: ${JSON.stringify(mockData)}`, 'info');
            
            try {
                // Crear formulario simulado
                const form = document.createElement('form');
                Object.entries(mockData).forEach(([key, value]) => {
                    const input = document.createElement('input');
                    input.name = key;
                    input.value = value;
                    form.appendChild(input);
                });
                
                const mockEvent = { preventDefault: () => {}, target: form };
                await window.ingresosModuleHandler.handleSubmit(mockEvent);
                
                debugLog('‚úÖ Env√≠o manual completado', 'success');
                
            } catch (error) {
                debugLog(`‚ùå Error en env√≠o manual: ${error.message}`, 'error');
            }
        }

        function clearConsole() {
            document.getElementById('debug-output').innerHTML = '';
            debugLog('üßπ Console limpiado', 'system');
        }

        // Interceptar console.log para mostrarlo tambi√©n en nuestra interface
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            
            // Solo mostrar logs que empiecen con ciertos prefijos
            const message = args.join(' ');
            if (message.includes('üìù') || message.includes('‚úÖ') || message.includes('‚ùå') || 
                message.includes('üîê') || message.includes('üìä') || message.includes('üåê')) {
                debugLog(message, 'info');
            }
        };

        // Funci√≥n para ejecutar script autom√°tico
        async function ejecutarPruebaAutomatica() {
            debugLog('ü§ñ Ejecutando prueba autom√°tica...', 'system');
            
            try {
                // Cargar el script de prueba
                const response = await fetch('./test-manual-console.js');
                const scriptContent = await response.text();
                
                // Ejecutar el script
                eval(scriptContent);
                
                debugLog('‚úÖ Script de prueba cargado y ejecutado', 'success');
                
            } catch (error) {
                debugLog(`‚ùå Error ejecutando prueba autom√°tica: ${error.message}`, 'error');
            }
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('üöÄ Debug Console inicializado', 'system');
            
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // Verificar estado inicial
            setTimeout(() => {
                checkAuth();
                testSupabaseConnection();
                checkTemplate();
                
                // Ejecutar prueba autom√°tica despu√©s de 2 segundos
                setTimeout(() => {
                    ejecutarPruebaAutomatica();
                }, 2000);
            }, 1000);
        });
    </script>
</body>
</html>
