<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificar M√≥dulo 4 - APIs PostgreSQL</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { border-color: #4CAF50; background-color: #f8fff8; }
        .error { border-color: #f44336; background-color: #fff8f8; }
        .pending { border-color: #ff9800; background-color: #fff8f0; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; max-height: 400px; }
        .credentials { background: #e3f2fd; padding: 10px; border-radius: 4px; margin: 10px 0; }
        input { margin: 5px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üîç Verificar M√≥dulo 4 - APIs PostgreSQL</h1>
    
    <div class="credentials">
        <h3>üîë Configuraci√≥n</h3>
        <input type="text" id="supabaseUrl" placeholder="Supabase URL" style="width: 300px;" value="https://trlbsfktusefvpheoudn.supabase.co">
        <input type="text" id="supabaseKey" placeholder="Anon Key" style="width: 400px;" value="">
        <br><br>
        <input type="email" id="email" placeholder="Email" value="test@ejemplo.com">
        <input type="password" id="password" placeholder="Password" value="Test123456!">
        <button onclick="authenticate()" style="background: #4CAF50; color: white; border: none;">üîë Autenticar</button>
        <div id="authStatus"></div>
    </div>

    <div class="test-section">
        <h3>üéØ Tests R√°pidos</h3>
        <button onclick="testFunction('api_crear_ingreso_avanzado')" style="background: #2196F3; color: white; border: none;">1Ô∏è‚É£ Test Crear Ingreso</button>
        <button onclick="testFunction('api_obtener_ingresos_avanzado')" style="background: #FF9800; color: white; border: none;">2Ô∏è‚É£ Test Obtener Ingresos</button>
        <button onclick="testFunction('api_dashboard_completo')" style="background: #9C27B0; color: white; border: none;">3Ô∏è‚É£ Test Dashboard</button>
        <button onclick="testFunction('api_crear_ingresos_lote')" style="background: #607D8B; color: white; border: none;">4Ô∏è‚É£ Test Lote</button>
        <br><br>
        <button onclick="runAllTests()" style="background: #4CAF50; color: white; border: none; font-size: 16px; padding: 12px 20px;">üöÄ EJECUTAR TODOS LOS TESTS</button>
    </div>

    <div id="testResults"></div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        let supabase;
        let authToken;
        let currentUser;

        async function authenticate() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!key) {
                document.getElementById('authStatus').innerHTML = `
                    <div style="color: red;">‚ùå Por favor ingresa la Anon Key de Supabase</div>
                    <div style="font-size: 12px; color: #666;">La encuentras en: Settings > API > Project API keys</div>
                `;
                return;
            }

            try {
                supabase = window.supabase.createClient(url, key);

                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                authToken = data.session.access_token;
                currentUser = data.user;
                
                document.getElementById('authStatus').innerHTML = `
                    <div style="color: green; margin-top: 10px;">‚úÖ Autenticado como: ${currentUser.email}</div>
                    <div style="color: blue; font-size: 12px;">User ID: ${currentUser.id}</div>
                `;
            } catch (error) {
                document.getElementById('authStatus').innerHTML = `
                    <div style="color: red;">‚ùå Error de autenticaci√≥n: ${error.message}</div>
                `;
            }
        }

        async function testFunction(functionName) {
            if (!supabase || !currentUser) {
                alert('Por favor autent√≠cate primero');
                return;
            }

            const testDiv = document.createElement('div');
            testDiv.className = 'test-section pending';
            testDiv.id = 'test-' + functionName;
            testDiv.innerHTML = `
                <h3>‚è≥ Testing ${functionName}</h3>
                <div>Ejecutando...</div>
            `;
            document.getElementById('testResults').appendChild(testDiv);

            try {
                let result;
                const userId = currentUser.id;

                switch (functionName) {
                    case 'api_crear_ingreso_avanzado':
                        result = await supabase.rpc('api_crear_ingreso_avanzado', {
                            p_usuario_id: userId,
                            p_descripcion: 'Test ingreso desde verificaci√≥n',
                            p_monto: 25000,
                            p_categoria: 'salario',
                            p_fecha: new Date().toISOString().split('T')[0]
                        });
                        break;

                    case 'api_obtener_ingresos_avanzado':
                        result = await supabase.rpc('api_obtener_ingresos_avanzado', {
                            p_usuario_id: userId,
                            p_categoria: null,
                            p_fecha_desde: null,
                            p_fecha_hasta: null,
                            p_limite: 10,
                            p_incluir_stats: true
                        });
                        break;

                    case 'api_dashboard_completo':
                        result = await supabase.rpc('api_dashboard_completo', {
                            p_usuario_id: userId,
                            p_periodo: 'month'
                        });
                        break;

                    case 'api_crear_ingresos_lote':
                        result = await supabase.rpc('api_crear_ingresos_lote', {
                            p_usuario_id: userId,
                            p_ingresos: [
                                { descripcion: 'Lote item 1', monto: 10000, categoria: 'freelance' },
                                { descripcion: 'Lote item 2', monto: 15000, categoria: 'negocio' }
                            ]
                        });
                        break;
                }

                if (result.error) throw result.error;

                testDiv.className = 'test-section success';
                testDiv.innerHTML = `
                    <h3>‚úÖ ${functionName} - EXITOSO</h3>
                    <pre>${JSON.stringify(result.data, null, 2)}</pre>
                `;
            } catch (error) {
                testDiv.className = 'test-section error';
                testDiv.innerHTML = `
                    <h3>‚ùå ${functionName} - ERROR</h3>
                    <div><strong>Error:</strong> ${error.message}</div>
                    <pre>${JSON.stringify(error, null, 2)}</pre>
                `;
            }
        }

        async function runAllTests() {
            if (!supabase || !currentUser) {
                alert('Por favor autent√≠cate primero');
                return;
            }

            document.getElementById('testResults').innerHTML = '<h2>üöÄ Ejecutando todos los tests...</h2>';

            const functions = [
                'api_crear_ingreso_avanzado',
                'api_obtener_ingresos_avanzado', 
                'api_dashboard_completo',
                'api_crear_ingresos_lote'
            ];

            for (let func of functions) {
                await testFunction(func);
                await new Promise(resolve => setTimeout(resolve, 1000)); // Pausa de 1 segundo entre tests
            }

            // Mostrar resumen
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'test-section';
            summaryDiv.style.background = '#e8f5e8';
            summaryDiv.style.border = '2px solid #4CAF50';
            summaryDiv.innerHTML = `
                <h2>üìä Resumen de Tests</h2>
                <div>‚úÖ Tests completados: ${functions.length}</div>
                <div>üéØ M√≥dulo 4 verificado exitosamente</div>
                <div>üöÄ APIs PostgreSQL funcionando correctamente</div>
                <hr>
                <p><strong>Pr√≥ximo paso:</strong> Continuar con M√≥dulo 5 - Frontend Development</p>
            `;
            document.getElementById('testResults').appendChild(summaryDiv);
        }

        // Auto-focus en el campo de anon key
        window.onload = function() {
            document.getElementById('supabaseKey').focus();
        };
    </script>
</body>
</html>
