<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Test M√≥dulo 4 - API Endpoints Personalizados</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #f5f7fa;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        .test-section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 2px solid #ddd; 
            border-radius: 12px; 
            background: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .success { 
            border-color: #4CAF50; 
            background-color: #f8fff8;
            box-shadow: 0 4px 6px rgba(76, 175, 80, 0.2);
        }
        .error { 
            border-color: #f44336; 
            background-color: #fff8f8;
            box-shadow: 0 4px 6px rgba(244, 67, 54, 0.2);
        }
        .pending { 
            border-color: #ff9800; 
            background-color: #fff8f0;
            box-shadow: 0 4px 6px rgba(255, 152, 0, 0.2);
        }
        .info { 
            border-color: #2196F3; 
            background-color: #f0f8ff;
            box-shadow: 0 4px 6px rgba(33, 150, 243, 0.2);
        }
        
        button { 
            padding: 12px 18px; 
            margin: 8px; 
            cursor: pointer; 
            border: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        pre { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 8px; 
            overflow-x: auto;
            font-size: 12px;
            max-height: 300px;
            border-left: 4px solid #007bff;
        }
        
        .credentials { 
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 25px; 
            border-radius: 12px; 
            margin: 20px 0;
            border: 2px solid #2196F3;
        }
        
        .credentials h3 {
            margin-top: 0;
            color: #1565c0;
        }
        
        input {
            padding: 10px;
            margin: 5px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }
        
        .status-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-pending { background: #fff3cd; color: #856404; }
        
        .endpoint-info {
            background: #f8f9fa;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .metric-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ Test Suite - M√≥dulo 4: API Endpoints Personalizados</h1>
        <p>Validaci√≥n completa de endpoints avanzados con funciones de negocio</p>
    </div>
    
    <div class="credentials">
        <h3>üîë Configuraci√≥n de Conexi√≥n</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <input type="text" id="supabaseUrl" placeholder="Supabase URL" 
                   value="https://trlbsfktusefvpheoudn.supabase.co" style="grid-column: 1 / -1;">
            <input type="text" id="supabaseKey" placeholder="Anon Key" 
                   style="grid-column: 1 / -1;" value="">
            <input type="email" id="email" placeholder="Email" value="test@ejemplo.com">
            <input type="password" id="password" placeholder="Password" value="Test123456!">
        </div>
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn-primary" onclick="authenticate()">üîë Autenticar Usuario</button>
            <button class="btn-success" onclick="runAllTests()" id="runTestsBtn" disabled>
                üß™ Ejecutar Todos los Tests
            </button>
        </div>
        <div id="authStatus"></div>
    </div>

    <div class="endpoint-info">
        <h4>üìã Endpoints a Probar</h4>
        <ul>
            <li><strong>POST /functions/v1/api-ingresos</strong> - Crear ingreso individual</li>
            <li><strong>PUT /functions/v1/api-ingresos</strong> - Crear ingresos en lote</li>
            <li><strong>GET /functions/v1/api-ingresos</strong> - Obtener ingresos con filtros</li>
            <li><strong>GET /functions/v1/api-dashboard</strong> - Dashboard completo con m√©tricas</li>
        </ul>
    </div>

    <div id="testMetrics" style="display: none;">
        <h3>üìä M√©tricas de Testing</h3>
        <div class="test-grid">
            <div class="metric-card">
                <div class="metric-value" id="totalTests">0</div>
                <div class="metric-label">Tests Ejecutados</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="passedTests">0</div>
                <div class="metric-label">Tests Exitosos</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="failedTests">0</div>
                <div class="metric-label">Tests Fallidos</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="executionTime">0</div>
                <div class="metric-label">Tiempo Total (s)</div>
            </div>
        </div>
    </div>

    <div id="testResults"></div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        let supabase;
        let authToken;
        let currentUser;
        let testStats = { total: 0, passed: 0, failed: 0, startTime: null };

        async function authenticate() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!url || !key || !email || !password) {
                document.getElementById('authStatus').innerHTML = `
                    <div style="color: red; margin-top: 15px;">
                        ‚ùå Por favor completa todos los campos
                    </div>
                `;
                return;
            }

            try {
                supabase = window.supabase.createClient(url, key);

                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                authToken = data.session.access_token;
                currentUser = data.user;
                
                document.getElementById('authStatus').innerHTML = `
                    <div style="color: green; margin-top: 15px; text-align: center;">
                        ‚úÖ <strong>Autenticado exitosamente como:</strong> ${currentUser.email}
                        <span class="status-indicator status-success">CONECTADO</span>
                    </div>
                `;
                
                document.getElementById('runTestsBtn').disabled = false;
            } catch (error) {
                document.getElementById('authStatus').innerHTML = `
                    <div style="color: red; margin-top: 15px; text-align: center;">
                        ‚ùå <strong>Error de autenticaci√≥n:</strong> ${error.message}
                        <span class="status-indicator status-error">ERROR</span>
                    </div>
                `;
            }
        }

        async function runAllTests() {
            testStats = { total: 0, passed: 0, failed: 0, startTime: Date.now() };
            document.getElementById('testMetrics').style.display = 'block';
            
            const tests = [
                { 
                    name: 'üîÑ Test 1: API Ingresos - Crear Individual', 
                    func: testCreateIngreso,
                    description: 'Crear un ingreso individual con validaciones'
                },
                { 
                    name: 'üì¶ Test 2: API Ingresos - Crear en Lote', 
                    func: testBulkIngresos,
                    description: 'Crear m√∫ltiples ingresos en una sola operaci√≥n'
                },
                { 
                    name: 'üîç Test 3: API Ingresos - Obtener con Filtros', 
                    func: testGetIngresos,
                    description: 'Obtener lista de ingresos con par√°metros de filtrado'
                },
                { 
                    name: 'üìä Test 4: API Dashboard Completo', 
                    func: testDashboard,
                    description: 'Obtener dashboard con m√©tricas, alertas y tendencias'
                },
                { 
                    name: 'üöÄ Test 5: Performance - M√∫ltiples Llamadas', 
                    func: testPerformance,
                    description: 'Medir tiempos de respuesta bajo carga'
                }
            ];

            document.getElementById('testResults').innerHTML = '';

            for (let test of tests) {
                await runTest(test.name, test.func, test.description);
                updateMetrics();
            }

            const executionTime = ((Date.now() - testStats.startTime) / 1000).toFixed(2);
            document.getElementById('executionTime').textContent = executionTime;

            // Resumen final
            const summaryDiv = document.createElement('div');
            summaryDiv.className = testStats.failed === 0 ? 'test-section success' : 'test-section error';
            summaryDiv.innerHTML = `
                <h3>üèÅ Resumen Final de Tests</h3>
                <div class="test-grid">
                    <div><strong>Total:</strong> ${testStats.total}</div>
                    <div><strong>Exitosos:</strong> ${testStats.passed}</div>
                    <div><strong>Fallidos:</strong> ${testStats.failed}</div>
                    <div><strong>Tiempo:</strong> ${executionTime}s</div>
                </div>
                <p><strong>Estado:</strong> ${testStats.failed === 0 ? '‚úÖ Todos los tests pasaron' : '‚ùå Algunos tests fallaron'}</p>
            `;
            document.getElementById('testResults').appendChild(summaryDiv);
        }

        async function runTest(testName, testFunc, description) {
            testStats.total++;
            
            const testDiv = document.createElement('div');
            testDiv.className = 'test-section pending';
            testDiv.innerHTML = `
                <h3>${testName}</h3>
                <p style="color: #666; font-style: italic;">${description}</p>
                <div>‚è≥ Ejecutando test... <span class="status-indicator status-pending">EN PROGRESO</span></div>
            `;
            document.getElementById('testResults').appendChild(testDiv);

            const startTime = Date.now();
            
            try {
                const result = await testFunc();
                const duration = Date.now() - startTime;
                
                testStats.passed++;
                testDiv.className = 'test-section success';
                testDiv.innerHTML = `
                    <h3>‚úÖ ${testName}</h3>
                    <p style="color: #666; font-style: italic;">${description}</p>
                    <div style="margin-bottom: 15px;">
                        <span class="status-indicator status-success">EXITOSO</span>
                        <span style="margin-left: 10px; color: #666;">‚è±Ô∏è ${duration}ms</span>
                    </div>
                    <details>
                        <summary style="cursor: pointer; font-weight: bold;">Ver Respuesta JSON</summary>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </details>
                `;
            } catch (error) {
                const duration = Date.now() - startTime;
                
                testStats.failed++;
                testDiv.className = 'test-section error';
                testDiv.innerHTML = `
                    <h3>‚ùå ${testName}</h3>
                    <p style="color: #666; font-style: italic;">${description}</p>
                    <div style="margin-bottom: 15px;">
                        <span class="status-indicator status-error">FALL√ì</span>
                        <span style="margin-left: 10px; color: #666;">‚è±Ô∏è ${duration}ms</span>
                    </div>
                    <div><strong>Error:</strong> ${error.message}</div>
                    <details>
                        <summary style="cursor: pointer; font-weight: bold;">Ver Detalles del Error</summary>
                        <pre style="color: #d32f2f;">${error.stack || error.message}</pre>
                    </details>
                `;
            }
        }

        function updateMetrics() {
            document.getElementById('totalTests').textContent = testStats.total;
            document.getElementById('passedTests').textContent = testStats.passed;
            document.getElementById('failedTests').textContent = testStats.failed;
        }

        // Tests individuales
        async function testCreateIngreso() {
            const baseUrl = document.getElementById('supabaseUrl').value;
            
            const response = await fetch(`${baseUrl}/functions/v1/api-ingresos`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    descripcion: 'Salario Test M√≥dulo 4',
                    monto: 75000,
                    categoria: 'salario',
                    fecha: new Date().toISOString().split('T')[0]
                })
            });

            if (!response.ok) {
                const errorData = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorData}`);
            }

            const result = await response.json();
            
            if (!result.success || !result.data) {
                throw new Error('Respuesta inv√°lida del endpoint');
            }

            return result;
        }

        async function testBulkIngresos() {
            const baseUrl = document.getElementById('supabaseUrl').value;
            
            const response = await fetch(`${baseUrl}/functions/v1/api-ingresos`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ingresos: [
                        { descripcion: 'Freelance Proyecto A', monto: 25000, categoria: 'freelance' },
                        { descripcion: 'Venta Online', monto: 12000, categoria: 'negocio' },
                        { descripcion: 'Dividendos ETF', monto: 5000, categoria: 'inversiones' }
                    ]
                })
            });

            if (!response.ok) {
                const errorData = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorData}`);
            }

            const result = await response.json();
            
            if (!result.success || !result.data || result.data.length !== 3) {
                throw new Error('Error en creaci√≥n de lote');
            }

            return result;
        }

        async function testGetIngresos() {
            const baseUrl = document.getElementById('supabaseUrl').value;
            
            const params = new URLSearchParams({
                categoria: 'salario',
                limit: '10',
                include_stats: 'true'
            });

            const response = await fetch(`${baseUrl}/functions/v1/api-ingresos?${params}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const errorData = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorData}`);
            }

            const result = await response.json();
            
            if (!result.success || !Array.isArray(result.data)) {
                throw new Error('Formato de respuesta inv√°lido');
            }

            return result;
        }

        async function testDashboard() {
            const baseUrl = document.getElementById('supabaseUrl').value;
            
            const params = new URLSearchParams({
                period: 'month',
                include_history: 'true'
            });

            const response = await fetch(`${baseUrl}/functions/v1/api-dashboard?${params}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const errorData = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorData}`);
            }

            const result = await response.json();
            
            if (!result.success || !result.data) {
                throw new Error('Dashboard no retorn√≥ datos v√°lidos');
            }

            // Validar estructura del dashboard
            const requiredFields = ['balance', 'trends', 'categories', 'alerts'];
            for (let field of requiredFields) {
                if (!(field in result.data)) {
                    throw new Error(`Campo requerido '${field}' faltante en dashboard`);
                }
            }

            return result;
        }

        async function testPerformance() {
            const baseUrl = document.getElementById('supabaseUrl').value;
            const startTime = Date.now();
            
            // Realizar m√∫ltiples llamadas concurrentes
            const promises = [];
            for (let i = 0; i < 5; i++) {
                promises.push(
                    fetch(`${baseUrl}/functions/v1/api-dashboard?period=month`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        }
                    })
                );
            }

            const responses = await Promise.all(promises);
            const endTime = Date.now();
            
            // Verificar que todas las respuestas sean exitosas
            for (let response of responses) {
                if (!response.ok) {
                    throw new Error(`Fall√≥ request concurrente: ${response.status}`);
                }
            }

            const totalTime = endTime - startTime;
            const avgTime = totalTime / 5;

            if (avgTime > 2000) {
                throw new Error(`Performance insuficiente: ${avgTime}ms promedio (m√°ximo: 2000ms)`);
            }

            return {
                total_requests: 5,
                total_time_ms: totalTime,
                average_time_ms: avgTime,
                requests_per_second: (5 * 1000 / totalTime).toFixed(2),
                status: 'performance_acceptable'
            };
        }
    </script>
</body>
</html>
